## "Video_stream"

### Основные поинты:

- [ ] WebRTC
- [ ] OpenCV (cv2) библиотека (захват потока и детектинг объектов)
- [ ] YOLO - библиотека (детектинг и обучение модели)
- [ ] ImageAI, Pygame, numpy
- [ ] ONVIF - протокол
- [ ] RTP - протокол
- [ ] SOAP - протокол
- [ ] UDP - протокол
- [ ] Xml-каскады
- [ ] Дальнейшая интеграция с Fast API (backend)
- [ ] Разобраться в захвате потока видео из удаленной ip-камеры на ubuntu:
  - модель моей камеры:   tp-link tapo TC70
  - ip-local camera:      192.168.1.167
  - мой статический ip:   31....
  - учетная запись камеры: username - antuanuran / пароль: 65...




### Терминология:
- **WebRTC** (Web Real-Time Communications) - технология, которая позволяет Web-приложениям и сайтам захватывать и выборочно передавать аудио и/или видео медиа-потоки, а также обмениваться произвольными данными между браузерами
- **UDP** (User Datagram Protocol) - это протокол пользовательских датаграмм. С помощью UDP компьютерные приложения могут посылать сообщения (датаграммы) другим хостам по IP-сети без необходимости предварительного сообщения для установки специальных каналов передачи или путей данных.
- **RTP** (Real-time Transport Protocol) сетевой протокол, спроектированный для мультимедийных коммуникаций (VoIP, видеоконференции, телепрезентации), потоковой передачи мультимедиа (видео по запросу, прямые трансляции) и широковещательное медиа
- **ONVIF** (Open Network Video Interface Forum) - общепринятый протокол для совместной работы IP-камер, видеорегистраторов NVR, программного обеспечения, на случай, если все устройства разных производителей. Разработали АПИ-спецификации для интеграции продуктов безопасности между собой и объединили их в профили, содержащие конкретные наборы функций. Протокол **ONVIF** подробно описывает, как сетевые устройства передачи видео (IP-камеры, видеорегистраторы), интегрируются с сетевыми программами обработки и отображения видеопотока.
- **YOLO** (You Only Look Once) — архитектура нейронных сетей, предназначенная для детекции объектов на изображении. Отличительной особенностью YOLO является подход к решению задачи детекции. Один из способов решения задачи детекции заключается в разбиении изображения на квадратные области, затем классификация этих областей на наличие объекта и классификация самого объекта
- https://habr.com/ru/articles/556404/ - теория по Yolo
- **SOAP** (Simple Object Access Protocol) — стандартный протокол по версии W3C. Данные передаются в формате XML. В отличие от REST-протокола, где данные передаются в json.
- **Датаграмма** (datagram) - это блок информации, передаваемый протоколом через сеть связи без предварительного установления соединения и создания виртуального канала. Любой протокол, не устанавливающий предварительное соединение (а также обычно не контролирующий порядок приёмо-передачи и дублирование пакетов), называется датаграммным протоколом. Таковы, например, протоколы Ethernet, IP, UDP и др.
- **Каскады** - признаки Хаара на определенные части лица: https://github.com/opencv/opencv/tree/4.x/data/haarcascades

### Описание процесса WebRTC:

#### Сокращенно:
  - 1.Захват камеры
  - 2.Кодирование (VP9)
  - 3.Запаковка в RTP-протокол
  - 4.Передача по сети пакетов через UDP
  - 5.Распаковка RTP
  - 6.Декодирование
  - 7.Получение MediaStream и связь с тегом в браузере

#### Развернуто:
- [x] **1. Захват камеры**:
  - есть некий API, который позволяет получить доступ к камере.
  При этом мы не имеем возможности получить чистые байты, только - media stream.
  - И дальше этот media stream нужно соединить с другим API.
  Учитывая, что видео состоит в среднем из 30 картинок в секунду, а каждая картинка весит около 1 мбайта,
  то на выходе мы получаем необходимый битрейт (возможность обработки данных в единицу времени) более 30 мбайт в секунду или (***240 mbps***)
  Такая проходимость нереальна, поэтому необходимо сжимать (кодировать)

- [x] **2. Кодирование**:
  - jpeg - не подходит, т.к. сжатие не сильное (примерно 1 к 10) - **24 mbps**.
  - Поэтому придумали другой способ сжатия - **VP9** (он сжимет примерно 1 к 200) - **1,5 mbps** вместо 240 mbps
  Суть его в том, что он определяет один главный кадр (***keyframe***) и далее определяет изменение относительно предыдущего кадра (***Дифф***)
  - Поэтому если потеряется один Дифф в середине, то дальше процесс может не пойти
  - И еще один важный момент, что ставка в этом кодировании идет на то, что изменение относительно небольшие между Диффами, но если же происходят резкие переходы (движения рукми в разные стороны), то могут происходить баги

- [x] **3. Запаковка в RTP**:
  - Для того, чтобы передать пакеты в сеть, они обворачиваются в Протокол **RTP**.
  - Данный протокол решает несколько задач, это: порядок пакетов (все пакеты должны идти получателю в том порядке, в котором они были отправлены), синхронизация времени аудио и видео-дорожек, правильное соединение дорожек между собой

- [x] **4. Передача пакетов по сети**:
  - Для передачи пакетов используется UDP - протокол (т.е. протокол без гарантий доставки пакетов в отличие от TCP)
  - За счет отсутствия гарантий, высокая скорость, т.к. пакеты отправляются все подряд по мере появления

- [x] **5. Распаковка RTP-протоколом**:
  - Протокол восстанавливает порядок пакетов и отправляет их в ***Декодер***

- [x] **6. Декодирование**:
  - Декодер уже наоборот расжимает обратно данные и собственно получаем тот самый ***MediaStream***, который изначально отправлялся с камеры одного пользователя на компьютер другого пользователя, который имеет доступ к данной камере.

- [x] **7. Воспроизведение**:
  - И в итоге мы прикручиваем данный ***MediaStream*** в HTML-разметку в тег


### Дополнительная информация:
- [ ] Дополнительная информация


